import fetch from "node-fetch";
import { createWriteStream, chmodSync, mkdir, mkdirSync } from "fs";
import { join, dirname } from "path";
import { fileURLToPath } from "url";

const arch = process.arch;
const platform = process.platform;

const SOPS_VERSION = "v3.9.1";
const SOPS_URL = `https://github.com/mozilla/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.${platform}.${arch}`;

const downloadSops = async () => {
  const response = await fetch(SOPS_URL);
  if (!response.ok) {
    throw new Error(`Failed to download sops: ${response.statusText}`);
  }

  const __filename = fileURLToPath(import.meta.url);
  const __dirname = dirname(__filename);

  const sopsPath = join(__dirname, ".bin", "sops");
  mkdirSync(dirname(sopsPath), { recursive: true });
  const fileStream = createWriteStream(sopsPath);
  await new Promise((resolve, reject) => {
    response.body.pipe(fileStream);
    response.body.on("error", reject);
    fileStream.on("finish", resolve);
  });

  chmodSync(sopsPath, "755");
};

downloadSops().catch((err) => {
  console.error(err);
  process.exit(1);
});
